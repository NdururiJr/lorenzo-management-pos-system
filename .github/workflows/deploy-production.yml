name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment platform'
        required: true
        default: 'vercel'
        type: choice
        options:
          - vercel
          - firebase
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: false
        type: boolean

# Prevent concurrent production deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checks
        run: npm run type-check

      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: npm test -- --passWithNoTests

      - name: Build verification
        run: npm run build
        env:
          NODE_ENV: production

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for versioning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_ENV: production

      # Deploy to Vercel Production
      - name: Deploy to Vercel Production
        id: deploy-vercel
        if: github.event.inputs.environment == 'vercel' || github.event.inputs.environment == ''
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
          scope: ${{ secrets.VERCEL_ORG_ID }}
          alias-domains: |
            lorenzo-dry-cleaners.vercel.app
            www.lorenzo-dry-cleaners.com

      # Deploy to Firebase Production
      - name: Deploy to Firebase Production
        id: deploy-firebase
        if: github.event.inputs.environment == 'firebase'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PRODUCTION }}'
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Set deployment URL
        id: deploy
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "firebase" ]]; then
            echo "url=${{ steps.deploy-firebase.outputs.details_url }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ steps.deploy-vercel.outputs.preview-url }}" >> $GITHUB_OUTPUT
          fi

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üöÄ Production Deployment Successful

          **Version:** ${{ steps.version.outputs.version }}
          **Commit:** ${{ steps.version.outputs.short_sha }}
          **Branch:** ${GITHUB_REF#refs/heads/}
          **Deployment URL:** ${{ steps.deploy.outputs.url }}
          **Platform:** ${{ github.event.inputs.environment || 'vercel' }}
          **Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Deployed by:** ${{ github.actor }}

          ---

          ### Recent Changes
          $(git log -5 --pretty=format:"- %s (%h)")
          EOF

  post-deployment-tests:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Health check
        run: |
          echo "Performing health check on production..."
          # Add actual health check commands here
          # Example: curl -f https://your-production-url.com/api/health

      - name: Smoke tests
        run: |
          echo "Running production smoke tests..."
          # Add smoke test commands here
          # Example: npm run test:e2e:production

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deployment-tests]
    if: success() && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version and changelog
        id: release-info
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

          # Generate changelog from commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release-info.outputs.tag }}
          release_name: Release ${{ steps.release-info.outputs.version }}
          body: |
            ## What's Changed
            ${{ steps.release-info.outputs.changelog }}

            ## Deployment Information
            - **Environment:** Production
            - **Platform:** ${{ github.event.inputs.environment || 'vercel' }}
            - **Deployed at:** ${{ github.event.head_commit.timestamp }}
            - **Deployed by:** @${{ github.actor }}
          draft: false
          prerelease: false

  notify-team:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deployment-tests]
    if: always()

    steps:
      - name: Send notification
        run: |
          if [[ "${{ needs.deploy-production.result }}" == "success" ]] && \
             [[ "${{ needs.post-deployment-tests.result }}" == "success" ]]; then
            echo "‚úÖ Production deployment successful!"
            # Add Slack/Discord/Email notification here
            # Example: curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} -d '{"text":"Production deployment successful!"}'
          else
            echo "‚ùå Production deployment failed or validation failed!"
            # Add failure notification here
            # Example: curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} -d '{"text":"Production deployment FAILED!"}'
          fi

      - name: Deployment summary
        run: |
          echo "Deployment Status: ${{ needs.deploy-production.result }}"
          echo "Validation Status: ${{ needs.post-deployment-tests.result }}"
