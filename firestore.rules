rules_version = '2';

/**
 * Firestore Security Rules for Lorenzo Dry Cleaners
 *
 * This file defines comprehensive security rules with role-based access control (RBAC)
 * for all collections in the database.
 *
 * User Roles:
 * - admin: Full system access
 * - manager: Branch-level management access
 * - front_desk: Order creation and payment processing
 * - workstation: Order status updates
 * - driver: Delivery management
 * - customer: Personal data access only
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Get the authenticated user's UID
     */
    function currentUserId() {
      return request.auth.uid;
    }

    /**
     * Get user's custom claims
     */
    function getUserRole() {
      return request.auth.token.role;
    }

    /**
     * Get user's branch ID from custom claims
     */
    function getUserBranch() {
      return request.auth.token.branchId;
    }

    /**
     * Get user's branchAccess array from custom claims (additional branches)
     */
    function getUserBranchAccess() {
      return request.auth.token.get('branchAccess', []);
    }

    /**
     * Check if user is a super admin (system-wide access)
     */
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.get('isSuperAdmin', false) == true;
    }

    /**
     * Get list of all branches user can access (primary + branchAccess)
     */
    function getAllowedBranches() {
      return getUserBranch() != null
        ? [getUserBranch()].concat(getUserBranchAccess())
        : getUserBranchAccess();
    }

    /**
     * Check if user has a specific role
     */
    function hasRole(role) {
      return isAuthenticated() && getUserRole() == role;
    }

    /**
     * Check if user has any of the specified roles
     */
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserRole() in roles;
    }

    /**
     * Check if user is admin (legacy - kept for compatibility)
     * NOTE: Use isSuperAdmin() for new code
     */
    function isAdmin() {
      return isSuperAdmin() || hasRole('admin');
    }

    /**
     * Check if user is admin or manager
     */
    function isManagement() {
      return isSuperAdmin() || hasAnyRole(['admin', 'director', 'general_manager', 'store_manager', 'manager']);
    }

    /**
     * Check if user is staff (any role except customer)
     */
    function isStaff() {
      return hasAnyRole(['admin', 'director', 'general_manager', 'store_manager', 'manager', 'workstation_manager', 'front_desk', 'workstation_staff', 'workstation', 'driver', 'satellite_staff']);
    }

    /**
     * Check if user belongs to a specific branch
     */
    function belongsToBranch(branchId) {
      return isAuthenticated() && getUserBranch() == branchId;
    }

    /**
     * Check if user can access branch data
     * Super admins can access all branches
     * Others can access branches in their allowedBranches list
     */
    function canAccessBranch(branchId) {
      return isSuperAdmin() || branchId in getAllowedBranches();
    }

    /**
     * Check if branchId is being changed (must remain immutable)
     */
    function branchIdChanged() {
      return request.resource.data.branchId != resource.data.branchId;
    }

    /**
     * Check if document exists
     */
    function documentExists(path) {
      return exists(/databases/$(database)/documents/$(path));
    }

    // ============================================
    // USERS COLLECTION
    // ============================================

    match /users/{userId} {
      // Users can read their own profile
      // Super admins can read all profiles
      // Managers can read profiles in their allowed branches
      allow read: if isAuthenticated() && (
        currentUserId() == userId ||
        isSuperAdmin() ||
        (isManagement() && canAccessBranch(resource.data.branchId))
      );

      // Only super admins can create new users
      allow create: if isSuperAdmin();

      // Users can update their own profile (limited fields only)
      // Super admins can update any profile
      // NOTE: branchId, branchAccess, isSuperAdmin, and role can only be changed by super admin
      allow update: if isAuthenticated() && (
        (currentUserId() == userId &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['name', 'phone', 'email']) &&
          !branchIdChanged()) ||
        isSuperAdmin()
      );

      // Only super admins can delete users
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // CUSTOMERS COLLECTION
    // ============================================

    match /customers/{customerId} {
      // Customers can read their own data
      // Staff can read all customers
      allow read: if isAuthenticated() && (
        resource.data.phone == request.auth.token.phone ||
        isStaff()
      );

      // Staff can create customers
      // Customers can create their own profile
      allow create: if isAuthenticated() && (
        isStaff() ||
        request.resource.data.phone == request.auth.token.phone
      );

      // Customers can update their own data
      // Staff can update customer data
      allow update: if isAuthenticated() && (
        resource.data.phone == request.auth.token.phone ||
        isStaff()
      );

      // Only admins can delete customers
      allow delete: if isAdmin();
    }

    // ============================================
    // ORDERS COLLECTION
    // ============================================

    match /orders/{orderId} {
      // Staff can read orders from their allowed branches
      // Super admins can read all orders
      // Customers can read orders if they match by email via customer lookup (handled in app)
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        canAccessBranch(resource.data.branchId) ||
        isStaff()
      );

      // Front desk and management can create orders in their allowed branches
      // branchId must match user's allowed branches
      allow create: if isAuthenticated() &&
        hasAnyRole(['admin', 'director', 'general_manager', 'store_manager', 'manager', 'front_desk', 'satellite_staff']) &&
        canAccessBranch(request.resource.data.branchId);

      // Staff can update orders (status, payment, etc.)
      // Workstation can only update status and garments
      // Drivers can update delivery status
      // branchId cannot be changed (immutable)
      allow update: if isAuthenticated() && !branchIdChanged() && (
        (hasAnyRole(['admin', 'director', 'general_manager', 'store_manager', 'manager', 'front_desk']) &&
          canAccessBranch(resource.data.branchId)) ||
        (hasAnyRole(['workstation_manager', 'workstation_staff', 'workstation']) &&
          canAccessBranch(resource.data.branchId) &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['status', 'garments', 'majorIssuesDetected', 'majorIssuesReviewedBy', 'majorIssuesApprovedAt', 'processingBatchId'])) ||
        (hasRole('driver') &&
          resource.data.driverId == currentUserId() &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['status', 'deliveryCompletedTime']))
      );

      // Only super admins can delete orders
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // BRANCHES COLLECTION
    // ============================================

    match /branches/{branchId} {
      // All authenticated users can read branches they have access to
      // Super admins can read all branches
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        canAccessBranch(branchId)
      );

      // Only super admins can create, update, or delete branches
      allow create, update, delete: if isSuperAdmin();
    }

    // ============================================
    // DELIVERIES COLLECTION
    // ============================================

    match /deliveries/{deliveryId} {
      // Drivers can read their assigned deliveries from their branch
      // Staff can read deliveries from their allowed branches
      // Super admins can read all deliveries
      allow read: if isAuthenticated() && (
        (resource.data.driverId == currentUserId() &&
          canAccessBranch(resource.data.branchId)) ||
        canAccessBranch(resource.data.branchId) ||
        isSuperAdmin()
      );

      // Management can create deliveries in their allowed branches
      // branchId must match user's allowed branches
      allow create: if isManagement() &&
        canAccessBranch(request.resource.data.branchId);

      // Drivers can update their assigned deliveries from their branch
      // Management can update deliveries in their allowed branches
      // branchId cannot be changed (immutable)
      allow update: if isAuthenticated() && !branchIdChanged() && (
        (resource.data.driverId == currentUserId() &&
          canAccessBranch(resource.data.branchId)) ||
        (isManagement() &&
          canAccessBranch(resource.data.branchId))
      );

      // Only super admins can delete deliveries
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // INVENTORY COLLECTION
    // ============================================

    match /inventory/{itemId} {
      // Staff can read inventory from their allowed branches
      // Super admins can read all inventory
      allow read: if isAuthenticated() && (
        canAccessBranch(resource.data.branchId) ||
        isSuperAdmin()
      );

      // Management and inventory staff can create and update inventory in their allowed branches
      // branchId cannot be changed after creation (immutable)
      allow create: if isManagement() &&
        canAccessBranch(request.resource.data.branchId);

      allow update: if isManagement() && !branchIdChanged() &&
        canAccessBranch(resource.data.branchId);

      // Only super admins can delete inventory items
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // INVENTORY TRANSFERS COLLECTION
    // ============================================

    match /inventoryTransfers/{transferId} {
      // Users can read transfers if they have access to either fromBranch or toBranch
      // Super admins can read all transfers
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        canAccessBranch(resource.data.fromBranchId) ||
        canAccessBranch(resource.data.toBranchId)
      );

      // Inventory staff/managers can create transfers from their allowed branches
      // Must have access to fromBranchId
      allow create: if isManagement() &&
        canAccessBranch(request.resource.data.fromBranchId) &&
        request.resource.data.status == 'draft';

      // Update rules based on status transitions and user permissions:
      // - Request: creator from fromBranch
      // - Approve/Reject: manager of fromBranch or super admin
      // - Mark in_transit: staff from fromBranch
      // - Receive: staff from toBranch
      // - Reconcile: manager of toBranch or super admin
      // fromBranchId and toBranchId are immutable
      allow update: if isAuthenticated() &&
        request.resource.data.fromBranchId == resource.data.fromBranchId &&
        request.resource.data.toBranchId == resource.data.toBranchId && (
          // Super admin can do anything
          isSuperAdmin() ||
          // Request transition (draft -> requested) by fromBranch staff
          (resource.data.status == 'draft' &&
           request.resource.data.status == 'requested' &&
           canAccessBranch(resource.data.fromBranchId)) ||
          // Approve/Reject by fromBranch manager or super admin
          ((resource.data.status == 'requested' &&
            (request.resource.data.status == 'approved' || request.resource.data.status == 'rejected') &&
            isManagement() &&
            canAccessBranch(resource.data.fromBranchId))) ||
          // Mark in_transit by fromBranch staff
          (resource.data.status == 'approved' &&
           request.resource.data.status == 'in_transit' &&
           canAccessBranch(resource.data.fromBranchId)) ||
          // Receive by toBranch staff
          (resource.data.status == 'in_transit' &&
           request.resource.data.status == 'received' &&
           canAccessBranch(resource.data.toBranchId)) ||
          // Reconcile by toBranch manager
          (resource.data.status == 'received' &&
           request.resource.data.status == 'reconciled' &&
           isManagement() &&
           canAccessBranch(resource.data.toBranchId)) ||
          // Cancel from draft or requested status
          ((resource.data.status in ['draft', 'requested']) &&
           request.resource.data.status == 'cancelled' &&
           canAccessBranch(resource.data.fromBranchId))
        );

      // Only super admins can delete transfers
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // TRANSACTIONS COLLECTION
    // ============================================

    match /transactions/{transactionId} {
      // Customers can read their own transactions
      // Staff can read transactions from their allowed branches
      // Super admins can read all transactions
      allow read: if isAuthenticated() && (
        resource.data.customerId == currentUserId() ||
        (isStaff() && canAccessBranch(resource.data.branchId)) ||
        isSuperAdmin()
      );

      // Front desk and management can create transactions in their allowed branches
      // branchId must match user's allowed branches
      allow create: if hasAnyRole(['admin', 'manager', 'front_desk']) &&
        canAccessBranch(request.resource.data.branchId);

      // Only management can update transactions in their allowed branches
      // Super admins can update all transactions
      // branchId cannot be changed (immutable)
      allow update: if !branchIdChanged() && (
        (isManagement() && canAccessBranch(resource.data.branchId)) ||
        isSuperAdmin()
      );

      // Only super admins can delete transactions
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================

    match /notifications/{notificationId} {
      // Users can read their own notifications
      // Staff can read all notifications
      allow read: if isAuthenticated() && (
        resource.data.recipientId == currentUserId() ||
        isStaff()
      );

      // Staff can create notifications
      allow create: if isStaff();

      // Only system (via admin SDK) can update notification status
      // Front-end can mark as read (if we add that field)
      allow update: if isStaff();

      // Only admins can delete notifications
      allow delete: if isAdmin();
    }

    // ============================================
    // PRICING COLLECTION
    // ============================================

    match /pricing/{pricingId} {
      // All authenticated users can read pricing
      allow read: if isAuthenticated();

      // Only super admins can create pricing
      allow create: if isSuperAdmin();

      // Only super admins can update pricing
      // branchId cannot be changed (immutable)
      allow update: if isSuperAdmin() && !branchIdChanged();

      // Only super admins can delete pricing
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // AUDIT LOGS COLLECTION
    // ============================================

    match /auditLogs/{auditLogId} {
      // Super admins can read all audit logs
      // Managers can read audit logs for their allowed branches
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        (isManagement() && (
          resource.data.branchId == null ||
          canAccessBranch(resource.data.branchId)
        ))
      );

      // Only authenticated staff can create audit logs
      // System/backend should create these via Admin SDK in production
      allow create: if isStaff();

      // Audit logs are immutable - no updates or deletes allowed
      // Only super admin can delete for compliance reasons
      allow update: if false;
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // DENY ALL OTHER ACCESS
    // ============================================

    // Explicitly deny access to any other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
